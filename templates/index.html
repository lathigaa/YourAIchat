<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dark-mode">
    <div class="chat-wrapper">
        <div class="sidebar">
            <div class="logo">YourAI</div>
            <h4>Saved Chats</h4>
            <button onclick="startNewChat()" class="chat-item new-chat">+ New Chat</button>
            <div id="conversationList"></div>
        </div>

        <div class="chat-main">
            <div class="chat-header">
                <h2>AI Chat</h2>
                <div>
                    <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
                    <button class="stop-btn" onclick="stopGeneration()">‚èπÔ∏è Stop</button>
                </div>
            </div>

            <div class="chat-box" id="chatBox"></div>

            <div class="chat-input">
                <input type="text" id="userInput" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
                <button onclick="saveConversation()">Save</button>
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let stopRequested = false;

        window.onload = function () {
            loadChats();
            loadTheme();
        };

        function toggleTheme() {
            const body = document.body;
            const currentMode = body.classList.contains("dark-mode") ? "dark" : "light";
            if (currentMode === "dark") {
                body.classList.remove("dark-mode");
                localStorage.setItem("theme", "light");
                document.querySelector(".theme-toggle").textContent = "üåô";
            } else {
                body.classList.add("dark-mode");
                localStorage.setItem("theme", "dark");
                document.querySelector(".theme-toggle").textContent = "‚òÄÔ∏è";
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem("theme") || "dark";
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                document.querySelector(".theme-toggle").textContent = "‚òÄÔ∏è";
            } else {
                document.body.classList.remove("dark-mode");
                document.querySelector(".theme-toggle").textContent = "üåô";
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById("userInput").value;
            const chatBox = document.getElementById("chatBox");

            if (!userInput.trim()) return;

            chatBox.innerHTML += `<div class="message user-msg">${userInput}</div>`;

            const loadingMessage = document.createElement("div");
            loadingMessage.classList.add("message", "ai-msg");
            loadingMessage.innerHTML = `Thinking...`;
            chatBox.appendChild(loadingMessage);

            document.getElementById("userInput").value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            stopRequested = false;

            try {
                const response = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userInput })
                });

                const data = await response.json();
                loadingMessage.innerHTML = `${data.response}`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                loadingMessage.innerHTML = `‚ö†Ô∏è Error: ${error.message}`;
            }
        }

        function saveConversation() {
            const chatBox = document.getElementById("chatBox");
            const conversationList = document.getElementById("conversationList");

            if (chatBox.innerHTML.trim() === "") return;

            const conversationHTML = chatBox.innerHTML;
            const chatTitle = prompt("Enter a name for the conversation:");

            if (chatTitle) {
                let savedChats = JSON.parse(localStorage.getItem("savedChats")) || [];
                savedChats.push({ title: chatTitle, content: conversationHTML });
                localStorage.setItem("savedChats", JSON.stringify(savedChats));
                renderChats();
            }
        }

        function renderChats() {
            const conversationList = document.getElementById("conversationList");
            conversationList.innerHTML = "";
            const savedChats = JSON.parse(localStorage.getItem("savedChats")) || [];

            savedChats.forEach((chat, index) => {
                const container = document.createElement("div");
                container.style.display = "flex";
                container.style.justifyContent = "space-between";
                container.style.alignItems = "center";
                container.classList.add("chat-item");

                const convoItem = document.createElement("span");
                convoItem.textContent = chat.title;
                convoItem.style.flex = "1";
                convoItem.style.cursor = "pointer";
                convoItem.onclick = function () {
                    document.getElementById("chatBox").innerHTML = chat.content;
                };

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "üóëÔ∏è";
                deleteBtn.style.border = "none";
                deleteBtn.style.background = "transparent";
                deleteBtn.style.cursor = "pointer";
                deleteBtn.onclick = function () {
                    deleteChat(index);
                };

                container.appendChild(convoItem);
                container.appendChild(deleteBtn);
                conversationList.appendChild(container);
            });
        }

        function deleteChat(index) {
            let savedChats = JSON.parse(localStorage.getItem("savedChats")) || [];
            savedChats.splice(index, 1);
            localStorage.setItem("savedChats", JSON.stringify(savedChats));
            renderChats();
        }

        function loadChats() {
            renderChats();
        }

        async function stopGeneration() {
            try {
                const response = await fetch("/stop", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                });

                const data = await response.json();
                const chatBox = document.getElementById("chatBox");
                chatBox.innerHTML += `<div class="message ai-msg">‚ö†Ô∏è Response generation stopped by user.</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error("Error stopping generation:", error);
            }
        }

        function startNewChat() {
            document.getElementById("chatBox").innerHTML = "";
        }
    </script>
</body>
</html>

